name: Update Documentation and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Validate scripts
      run: |
        echo "Validating shell scripts..."
        find . -name "*.sh" -exec bash -n {} \;
        echo "All shell scripts are valid"
        
    - name: Check file permissions
      run: |
        echo "Checking file permissions..."
        ls -la *.sh
        ls -la *.py
        
    - name: Create release notes
      run: |
        echo "Creating release notes..."
        cat > RELEASE_NOTES.md << EOF
        # Release Notes - OpenClashèŠ‚ç‚¹ç®¡ç†ç³»ç»Ÿ
        
        ## æœ€æ–°æ›´æ–°
        
        ### ðŸ”„ æ–°å¢žåŠŸèƒ½ï¼šå¼€æœºè‡ªå¯åŠ¨å’ŒåŽå°è¿è¡Œ
        
        - âœ… **å¼€æœºè‡ªå¯åŠ¨**ï¼šç³»ç»Ÿé‡å¯åŽè‡ªåŠ¨å¯åŠ¨æœåŠ¡
        - âœ… **åŽå°è¿è¡Œ**ï¼šæœåŠ¡åœ¨åŽå°æŒç»­è¿è¡Œï¼Œä¸å ç”¨ç»ˆç«¯
        - âœ… **è‡ªåŠ¨é‡å¯**ï¼šæœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨é‡å¯
        - âœ… **æœåŠ¡ç®¡ç†**ï¼šä¾¿æ·çš„systemdæœåŠ¡ç®¡ç†
        - âœ… **æ—¥å¿—ç®¡ç†**ï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•å’ŒæŸ¥çœ‹åŠŸèƒ½
        
        ### ðŸ“ æ–°å¢žæ–‡ä»¶
        
        - `auto_start.sh` - å¿«é€Ÿè‡ªåŠ¨å¯åŠ¨è„šæœ¬
        - `service_manager.sh` - æœåŠ¡ç®¡ç†è„šæœ¬
        - `systemd_service.sh` - å®Œæ•´systemdå®‰è£…è„šæœ¬
        - `README_AutoStart.md` - å¼€æœºè‡ªå¯åŠ¨è¯¦ç»†è¯´æ˜Žæ–‡æ¡£
        
        ### ðŸ”§ æ›´æ–°å†…å®¹
        
        - æ›´æ–° `install.sh` - ä¸€é”®å®‰è£…è„šæœ¬ï¼Œé›†æˆå¼€æœºè‡ªå¯åŠ¨åŠŸèƒ½
        - æ›´æ–° `README.md` - ä¸»æ–‡æ¡£ï¼Œæ·»åŠ å¼€æœºè‡ªå¯åŠ¨è¯´æ˜Ž
        - ä¼˜åŒ–æœåŠ¡ç®¡ç†æµç¨‹
        - å¢žå¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
        
        ### ðŸš€ ä½¿ç”¨æ–¹æ³•
        
        #### ä¸€é”®å®‰è£…ï¼ˆæŽ¨èï¼‰
        \`\`\`bash
        wget -O - https://raw.githubusercontent.com/kuku0799/5000/main/install.sh | bash
        \`\`\`
        
        #### æ‰‹åŠ¨è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
        \`\`\`bash
        chmod +x auto_start.sh
        sudo ./auto_start.sh
        \`\`\`
        
        #### æœåŠ¡ç®¡ç†
        \`\`\`bash
        # æŸ¥çœ‹çŠ¶æ€
        sudo systemctl status openclash-manager.service
        
        # æŸ¥çœ‹æ—¥å¿—
        sudo journalctl -u openclash-manager.service -f
        
        # é‡å¯æœåŠ¡
        sudo systemctl restart openclash-manager.service
        \`\`\`
        
        ### ðŸ“Š ç³»ç»Ÿè¦æ±‚
        
        - OpenWrt ç³»ç»Ÿ
        - Python 3.6+
        - systemd æ”¯æŒï¼ˆæŽ¨èï¼‰
        - OpenClash æ’ä»¶
        
        ### ðŸ”’ å®‰å…¨ç‰¹æ€§
        
        - æœåŠ¡éš”ç¦»å’Œæƒé™æŽ§åˆ¶
        - è‡ªåŠ¨é…ç½®éªŒè¯
        - é”™è¯¯æ—¶è‡ªåŠ¨å›žæ»š
        - å®Œæ•´çš„æ—¥å¿—è®°å½•
        
        ---
        
        **æ³¨æ„**ï¼šå»ºè®®åœ¨å®‰è£…å‰å¤‡ä»½çŽ°æœ‰é…ç½®ã€‚
        EOF
        
    - name: Update file list
      run: |
        echo "Updating file list..."
        cat > FILE_LIST.md << EOF
        # é¡¹ç›®æ–‡ä»¶åˆ—è¡¨
        
        ## æ ¸å¿ƒç³»ç»Ÿæ–‡ä»¶
        
        - \`jk.sh\` - å®ˆæŠ¤è¿›ç¨‹è„šæœ¬
        - \`zr.py\` - ä¸»æŽ§åˆ¶å™¨
        - \`jx.py\` - èŠ‚ç‚¹è§£æžå™¨
        - \`zw.py\` - ä»£ç†æ³¨å…¥å™¨
        - \`zc.py\` - ç­–ç•¥ç»„æ³¨å…¥å™¨
        - \`log.py\` - æ—¥å¿—ç®¡ç†å™¨
        
        ## Webç¼–è¾‘å™¨
        
        - \`web_editor.py\` - WebæœåŠ¡å™¨
        - \`templates/index.html\` - å‰ç«¯ç•Œé¢
        - \`requirements.txt\` - Pythonä¾èµ–
        - \`start_web_editor.sh\` - å¯åŠ¨è„šæœ¬
        
        ## å¼€æœºè‡ªå¯åŠ¨
        
        - \`auto_start.sh\` - å¿«é€Ÿè‡ªåŠ¨å¯åŠ¨è„šæœ¬
        - \`service_manager.sh\` - æœåŠ¡ç®¡ç†è„šæœ¬
        - \`systemd_service.sh\` - å®Œæ•´systemdå®‰è£…è„šæœ¬
        - \`README_AutoStart.md\` - è‡ªå¯åŠ¨è¯´æ˜Žæ–‡æ¡£
        
        ## å®‰è£…å’Œé…ç½®
        
        - \`install.sh\` - ä¸€é”®å®‰è£…è„šæœ¬
        - \`README.md\` - ä¸»è¯´æ˜Žæ–‡æ¡£
        - \`README_Web_Editor.md\` - Webç¼–è¾‘å™¨è¯´æ˜Ž
        - \`LICENSE\` - è®¸å¯è¯æ–‡ä»¶
        
        ## å…¶ä»–æ–‡ä»¶
        
        - \`test_links.py\` - é“¾æŽ¥æµ‹è¯•å·¥å…·
        - \`fix_dependencies.sh\` - ä¾èµ–ä¿®å¤è„šæœ¬
        - \`QUICK_DEPLOY.md\` - å¿«é€Ÿéƒ¨ç½²è¯´æ˜Ž
        - \`DEPLOYMENT_SUMMARY.md\` - éƒ¨ç½²æ€»ç»“
        EOF
        
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --quiet && git diff --staged --quiet || git commit -m "Update documentation and add auto-start features"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
        
  create-release:
    needs: update-docs
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## ðŸ”„ å¼€æœºè‡ªå¯åŠ¨åŠŸèƒ½æ›´æ–°
          
          ### æ–°å¢žåŠŸèƒ½
          - âœ… å¼€æœºè‡ªå¯åŠ¨æ”¯æŒ
          - âœ… åŽå°è¿è¡ŒæœåŠ¡
          - âœ… è‡ªåŠ¨é‡å¯æœºåˆ¶
          - âœ… systemdæœåŠ¡ç®¡ç†
          - âœ… å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ
          
          ### ä½¿ç”¨æ–¹æ³•
          ```bash
          # ä¸€é”®å®‰è£…ï¼ˆæŽ¨èï¼‰
          wget -O - https://raw.githubusercontent.com/kuku0799/5000/main/install.sh | bash
          
          # æ‰‹åŠ¨è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
          chmod +x auto_start.sh
          sudo ./auto_start.sh
          ```
          
          ### æœåŠ¡ç®¡ç†
          ```bash
          # æŸ¥çœ‹çŠ¶æ€
          sudo systemctl status openclash-manager.service
          
          # æŸ¥çœ‹æ—¥å¿—
          sudo journalctl -u openclash-manager.service -f
          ```
          
          è¯¦ç»†è¯´æ˜Žè¯·æŸ¥çœ‹ README_AutoStart.md
        draft: false
        prerelease: false 